<app-form
  title="Módulo de Cotizaciones"
  description="Gestión y seguimiento de cotizaciones"
  icon="pi-dollar"
  iconColor="blue"
  [editing]="editing"
  entityName="cotización"
>
  <form
    [formGroup]="form"
    (ngSubmit)="submit()"
    class="space-y-6"
  >
    <!-- Cabecera principal 2 columnas -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Columna izquierda -->
      <div class="flex flex-col gap-6">
        <!-- Cliente typeahead usando app-input -->
        <div
          class="relative"
          (click)="stopClick($event)"
          (focusin)="showPanelCliente = clientes.length > 0"
        >
          <label class="block text-sm font-medium mb-1">Cliente</label>
          <app-input
            type="search"
            name="searchCliente"
            class="w-full"
            placeholder="Buscar un cliente"
            [(ngModel)]="searchCliente"
            (ngModelChange)="onSearchCliente($event)"
            [ngModelOptions]="{ standalone: true }"
            [invalid]="
              form.controls.clienteId.touched && form.controls.clienteId.invalid
            "
            autocomplete="off"
            size="md"
          ></app-input>
          <button
            *ngIf="searchCliente"
            type="button"
            (click)="clearCliente($event)"
            class="absolute inset-y-0 right-2 flex items-center text-gray-400 hover:text-gray-600"
          >
            <i class="pi pi-times text-xs"></i>
          </button>
          <div
            *ngIf="showPanelCliente"
            class="absolute z-20 mt-1 w-full rounded-xl bg-white dark:bg-dark-700 shadow-lg ring-1 ring-black/5 max-h-64 overflow-auto text-sm"
          >
            <div
              *ngIf="isLoadingCliente"
              class="py-6 flex items-center justify-center gap-2 text-gray-500"
            >
              <i class="pi pi-spin pi-spinner"></i>
              Buscando...
            </div>
            <ng-container *ngIf="!isLoadingCliente">
              <button
                *ngFor="let c of clientes; trackBy: trackByCliente"
                type="button"
                (click)="pickCliente(c)"
                class="w-full text-left px-3 py-2 hover:bg-dark-50 dark:hover:bg-dark-600 flex flex-col"
              >
                <span class="font-medium">{{ c.nombre }}</span>
                <span class="text-[10px] text-gray-500">{{
                  c.clave || "—"
                }}</span>
              </button>
              <div
                *ngIf="
                  !clientes.length &&
                  searchCliente.length >= 2 &&
                  !isLoadingCliente
                "
                class="px-3 py-4 text-center text-gray-400 text-xs"
              >
                Sin resultados
              </div>
            </ng-container>
          </div>
          <div class="mt-1 h-5 text-xs overflow-hidden flex items-center gap-1">
            <span
              *ngIf="
                form.controls.clienteId.touched &&
                form.controls.clienteId.invalid
              "
              class="text-red-600"
              >Requerido</span
            >
            <span
              *ngIf="!form.controls.clienteId.invalid && selectedCliente"
              class="text-green-600 flex items-center gap-1"
              ><i class="pi pi-check-circle"></i> Seleccionado:
              {{ selectedCliente.nombre }}</span
            >
          </div>
        </div>

        <!-- Atención typeahead usando app-input -->
        <div
          class="relative"
          (click)="stopClick($event)"
          (focusin)="showAtencionPanel = usuarios.length > 0"
        >
          <label class="block text-sm font-medium mb-1">Atención</label>
          <app-input
            type="search"
            name="searchUsuario"
            class="w-full"
            placeholder="Buscar un usuario"
            [(ngModel)]="searchUsuario"
            (ngModelChange)="onSearchUsuario($event)"
            [ngModelOptions]="{ standalone: true }"
            [invalid]="
              form.controls.atencionId.touched &&
              form.controls.atencionId.invalid
            "
            autocomplete="off"
            size="md"
          ></app-input>
          <button
            *ngIf="searchUsuario"
            type="button"
            (click)="clearAtencion($event)"
            class="absolute inset-y-0 right-2 flex items-center text-gray-400 hover:text-gray-600"
          >
            <i class="pi pi-times text-xs"></i>
          </button>
          <div
            *ngIf="showAtencionPanel"
            class="absolute z-20 mt-1 w-full rounded-xl bg-white dark:bg-dark-700 shadow-lg ring-1 ring-black/5 max-h-64 overflow-auto text-sm"
          >
            <div
              *ngIf="atencionLoading"
              class="py-6 flex items-center justify-center gap-2 text-gray-500"
            >
              <i class="pi pi-spin pi-spinner"></i>
              Buscando...
            </div>
            <ng-container *ngIf="!atencionLoading">
              <button
                *ngFor="let u of usuarios; trackBy: trackByAtencion"
                type="button"
                (click)="pickAtencion(u)"
                class="w-full text-left px-3 py-2 hover:bg-dark-50 dark:hover:bg-dark-600 flex flex-col"
              >
                <span class="font-medium">{{ u.nombre }}</span>
                <span class="text-[10px] text-gray-500">{{
                  u.correo || "—"
                }}</span>
              </button>
              <div
                *ngIf="
                  !usuarios.length &&
                  searchUsuario.length >= 2 &&
                  !atencionLoading
                "
                class="px-3 py-4 text-center text-gray-400 text-xs"
              >
                Sin resultados
              </div>
            </ng-container>
          </div>
          <div class="mt-1 h-5 text-xs overflow-hidden flex items-center gap-1">
            <span
              *ngIf="
                form.controls.atencionId.touched &&
                form.controls.atencionId.invalid
              "
              class="text-red-600"
              >Requerido</span
            >
            <span
              *ngIf="!form.controls.atencionId.invalid && selectedAtencion"
              class="text-green-600 flex items-center gap-1"
              ><i class="pi pi-check-circle"></i> Seleccionado:
              {{ selectedAtencion.nombre }}</span
            >
          </div>
        </div>
        <div>
          <app-input label="Fecha" type="date" formControlName="fecha" />
          <div class="mt-1 h-5"></div>
        </div>
      </div>
      <!-- Columna derecha -->
      <div class="flex flex-col gap-6">
        <div>
          <app-input
            label="No. Cotización"
            type="number"
            formControlName="numero"
            placeholder="Autogenerado si se omite"
          />
          <div class="mt-1 h-5"></div>
        </div>
        <div>
          <app-input
            label="Condiciones especiales"
            formControlName="condicionesEspeciales"
            placeholder=""
          />
          <div class="mt-1 h-5"></div>
        </div>
        <div>
          <app-input
            label="Teléfono"
            formControlName="telefonoRq"
            placeholder=""
          />
          <div class="mt-1 h-5"></div>
        </div>
      </div>
    </div>

    <!-- Segunda fila: grid 5 columnas -->
    <div class="grid md:grid-cols-5 gap-6">
      <app-input
        label="Vigencia"
        type="date"
        formControlName="fechaVigencia"
        size="sm"
      />
      <app-input
        label="Forma de pago"
        type="select"
        formControlName="formaPago"
        [options]="formasPago"
        size="sm"
        [placeholderOption]="false"
      />
      <app-input
        label="Tiempo entrega"
        type="select"
        formControlName="tiempoEntrega"
        [options]="tiemposEntrega"
        size="sm"
        [placeholderOption]="false"
      />
      <app-input
        label="Precios en"
        type="select"
        formControlName="preciosEn"
        [options]="monedas"
        size="sm"
        [placeholderOption]="false"
      />
      <div>
        <app-input
          label="Tipo cambio"
          type="currency"
          step="0.0001"
          formControlName="tipoCambio"
          size="sm"
        />
        <div
          *ngIf="form.value.preciosEn === 'DLS' && suggestedTipoCambio"
          class="col-span-full text-end text-[11px] text-gray-500 dark:text-gray-400 mt-1"
        >
          Sugerido Banxico:
          <span class="font-semibold"
            >$ {{ suggestedTipoCambio | number : "1.4-4" }} MXN</span
          >
          <button
            type="button"
            (click)="applySuggestedTipoCambio()"
            class="ml-2 text-blue-600 dark:text-blue-400 hover:underline"
          >
            Usar
          </button>
        </div>
      </div>
    </div>

    <!-- Detalles -->
    <div class="space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-200">
          Partidas
        </h3>
        <button
          type="button"
          (click)="addDetalle()"
          class="inline-flex items-center gap-2 hover:bg-blue-600 hover:text-white text-blue-600 dark:text-blue-400 dark:hover:bg-blue-600 font-semibold px-5 py-2.5 rounded-xl text-sm"
        >
          <i class="pi pi-plus text-xs"></i> Agregar
        </button>
      </div>
      <!-- Tabla (desktop) -->
      <div
        class="overflow-x-auto rounded-xl ring-1 ring-dark-100 dark:ring-dark-700 hidden md:block"
      >
        <table class="min-w-full text-xs">
          <thead
            class="bg-dark-50 dark:bg-dark-600 text-[10px] uppercase tracking-wide text-gray-500"
          >
            <tr>
              <th class="py-2 text-center">Partida No.</th>
              <th class="py-2 text-center">Cantidad</th>
              <th class="py-2 text-center">Descripción</th>
              <th class="py-2 text-center">Precio lista</th>
              <th class="py-2 text-center">Desc (%)</th>
              <th class="py-2 text-center">P. Unit</th>
              <th class="py-2 text-center">Subtotal</th>
              <th class="py-2 text-center">IVA 16%</th>
              <th class="py-2 text-center">Total</th>
              <th class="py-2"></th>
            </tr>
          </thead>
          <tbody
            class="divide-y divide-dark-50 dark:divide-dark-700 bg-white dark:bg-dark-500"
            formArrayName="detalles"
          >
            <tr
              *ngFor="let d of form.controls.detalles.controls; let i = index"
              [formGroupName]="i"
              class="text-center"
            >
              <td class="py-2 font-medium text-gray-500">{{ i + 1 }}</td>
              <td class="py-2">
                <div class="w-20 mx-auto">
                  <app-input
                    type="number"
                    formControlName="cantidad"
                    size="sm"
                    [inputClass]="'text-center pl-6'"
                    min="1"
                  ></app-input>
                </div>
              </td>
              <td class="py-2 w-64">
                <app-input
                  type="text"
                  formControlName="descripcion"
                  size="sm"
                  [inputClass]="'text-center'"
                ></app-input>
              </td>
              <td class="py-2">
                <div class="w-28 mx-auto">
                  <app-input
                    type="currency"
                    formControlName="precioLista"
                    size="sm"
                    [currencySymbol]="'$'"
                    currencyLocale="es-MX"
                    [inputClass]="'text-center'"
                  ></app-input>
                </div>
              </td>
              <td class="py-2">
                <div class="w-20 mx-auto">
                  <app-input
                    type="percent"
                    formControlName="descuento"
                    size="sm"
                    [inputClass]="'text-center'"
                    [percentDecimals]="2"
                  ></app-input>
                </div>
              </td>
              <td class="py-2 tabular-nums">
                $ {{ linePrecioUnit(i) | number : "1.2-2" }}
              </td>
              <td class="py-2 tabular-nums">
                $ {{ lineSubtotal(i) | number : "1.2-2" }}
              </td>
              <td class="py-2 tabular-nums">
                $ {{ lineIva(i) | number : "1.2-2" }}
              </td>
              <td class="py-2 font-medium tabular-nums">
                $ {{ lineTotal(i) | number : "1.2-2" }}
              </td>
              <td class="py-2">
                <button
                  type="button"
                  (click)="removeDetalle(i)"
                  [disabled]="form.controls.detalles.controls.length === 1"
                  class="text-red-500 hover:text-red-600 disabled:opacity-50"
                >
                  <i class="pi pi-times"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot class="bg-dark-50 dark:bg-dark-600 text-center">
            <tr>
              <td colspan="6"></td>
              <td class="px-2 pt-2 text-[10px] uppercase text-gray-500">
                Subtotal
              </td>
              <td class="px-2 pt-2 text-[10px] uppercase text-gray-500">
                IVA 16%
              </td>
              <td class="px-2 pt-2 text-[10px] uppercase text-gray-500">
                Total
              </td>
              <td></td>
            </tr>
            <tr>
              <td colspan="6"></td>
              <td class="px-2 pb-2 font-semibold tabular-nums">
                $ {{ subtotal | number : "1.2-2" }}
              </td>
              <td class="px-2 pb-2 font-semibold tabular-nums">
                $ {{ ivaAl16 | number : "1.2-2" }}
              </td>
              <td class="px-2 pb-2 font-bold tabular-nums">
                $ {{ total | number : "1.2-2" }}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Lista mobile -->
      <div class="md:hidden space-y-3" formArrayName="detalles">
        <button
          type="button"
          (click)="addDetalle()"
          class="w-full inline-flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium"
        >
          <i class="pi pi-plus text-xs"></i> Agregar partida
        </button>
        <div
          *ngFor="
            let d of form.controls.detalles.controls;
            let i = index;
            trackBy: trackByDetalle
          "
          [formGroupName]="i"
          class="rounded-2xl bg-dark-50 dark:bg-dark-600 shadow-sm p-4 flex flex-col gap-3"
        >
          <!-- Header card -->
          <div class="flex items-start justify-between">
            <div class="flex flex-col">
              <span class="text-[11px] uppercase tracking-wide text-gray-500"
                >Partida</span
              >
              <span
                class="text-sm font-semibold text-gray-800 dark:text-gray-100"
                >#{{ i + 1 }}</span
              >
            </div>
            <button
              type="button"
              (click)="removeDetalle(i)"
              [disabled]="form.controls.detalles.controls.length === 1"
              class="text-red-500 hover:text-red-600 disabled:opacity-40 disabled:cursor-not-allowed text-xs inline-flex items-center gap-1"
              title="Eliminar partida"
            >
              <i class="pi pi-trash text-xs"></i>
            </button>
          </div>
          <!-- Campos -->
          <div class="grid grid-cols-3 gap-3">
            <app-input
              label="Cantidad"
              type="number"
              formControlName="cantidad"
              size="sm"
            />
            <app-input
              label="Precio lista"
              type="currency"
              formControlName="precioLista"
              size="sm"
            />
            <app-input
              label="Desc (%)"
              type="percent"
              step="0.01"
              formControlName="descuento"
              size="sm"
            />
            <div class="col-span-3">
              <app-input
                label="Descripción"
                formControlName="descripcion"
                size="sm"
              />
            </div>
          </div>
          <!-- Totals -->
          <div
            class="grid grid-cols-2 gap-x-4 gap-y-1 pt-1 text-[11px] text-gray-500 dark:text-gray-400 tabular-nums"
          >
            <div>Precio Unitario</div>
            <div
              class="text-right font-medium text-gray-700 dark:text-gray-200"
            >
              {{ linePrecioUnit(i) | number : "1.2-2" }}
            </div>
            <div>Subtotal</div>
            <div
              class="text-right font-medium text-gray-700 dark:text-gray-200"
            >
              {{ lineSubtotal(i) | number : "1.2-2" }}
            </div>
            <div>IVA 16%</div>
            <div
              class="text-right font-medium text-gray-700 dark:text-gray-200"
            >
              {{ lineIva(i) | number : "1.2-2" }}
            </div>
            <div>Total</div>
            <div class="text-right font-bold text-gray-800 dark:text-gray-100">
              {{ lineTotal(i) | number : "1.2-2" }}
            </div>
          </div>
        </div>
        <div
          class="rounded-2xl bg-dark-50 dark:bg-dark-600 shadow-sm p-4 flex flex-col gap-3"
        >
          <!-- Totals generales -->
          <div class="text-sm font-semibold text-gray-700 dark:text-gray-200">
            Total general
          </div>
          <div
            class="grid grid-cols-2 gap-x-4 gap-y-1 pt-1 text-[11px] text-gray-500 dark:text-gray-400 tabular-nums"
          >
            <div>Subtotal</div>
            <div
              class="text-right font-medium text-gray-700 dark:text-gray-200"
            >
              {{ subtotal | number : "1.2-2" }}
            </div>
            <div>IVA 16%</div>
            <div
              class="text-right font-medium text-gray-700 dark:text-gray-200"
            >
              {{ ivaAl16 | number : "1.2-2" }}
            </div>
            <div>Total</div>
            <div class="text-right font-bold text-gray-800 dark:text-gray-100">
              {{ total | number : "1.2-2" }}
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-row justify-end text-end gap-4">
        <div class="text-xs text-gray-500 space-y-1">
          <div *ngIf="form.value.preciosEn === 'DLS'">
            Total en pesos: $
            {{ (total || 0) * (form.value.tipoCambio || 0) | number : "1.2-2" }}
          </div>
          <div *ngIf="form.value.preciosEn === 'DLS'">
            Tipo cambio: $ {{ form.value.tipoCambio | number : "1.2-2" }}
          </div>
        </div>
      </div>
    </div>

    <!-- Notas -->
    <div>
      <label class="block text-sm font-medium mb-1">Notas adicionales</label>
      <textarea
        formControlName="notas"
        rows="3"
        class="w-full rounded-xl bg-white dark:bg-dark-800 text-gray-900 dark:text-white placeholder:text-gray-500 ring-1 ring-gray-300 dark:ring-dark-700 focus:ring-2 focus:ring-blue-600 dark:focus:ring-blue-500 outline-none px-3 py-2 text-sm"
      ></textarea>
    </div>

    <div
      class="flex flex-col md:flex-row md:items-center md:justify-end gap-4 pt-2"
    >
      <div class="flex items-center justify-end gap-3">
        <button
          type="button"
          (click)="back()"
          class="px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-dark-50 dark:bg-dark-500 dark:hover:bg-dark-600 text-dark-500 dark:text-dark-100"
        >
          <i class="pi pi-times"></i>
          <span> Cancelar </span>
        </button>
        <button
          type="submit"
          [disabled]="submitting || loading"
          class="inline-flex items-center gap-2 hover:bg-blue-600 hover:text-white text-blue-600 dark:text-blue-400 dark:hover:bg-blue-600 font-semibold disabled:opacity-60 px-6 py-2.5 rounded-xl text-sm"
        >
          <i
            class="pi"
            [ngClass]="
              submitting
                ? 'pi-spin pi-spinner'
                : editing
                ? 'pi-check'
                : 'pi-save'
            "
          ></i>
          <span>{{ editing ? "Listo" : "Guardar" }}</span>
        </button>
      </div>
    </div>
  </form>
</app-form>
